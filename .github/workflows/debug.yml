name: Build Kivy Android APK In Debug Mode

on:
  workflow_dispatch:

permissions:
  contents: write
  actions: read
  checks: read

# æ ¸å¿ƒä¼˜åŒ–ï¼šå¢å¤§æ„å»ºè™šæ‹Ÿæœºèµ„æº + å›½å†…é•œåƒåŠ é€Ÿ
env:
  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
  ANDROID_HOME: /usr/local/lib/android/sdk
  JAVA_HOME: /usr/lib/jvm/temurin-17-jdk-amd64
  CYTHON_LANGUAGE_LEVEL: "3"
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.java-home=$JAVA_HOME -Dorg.gradle.jvmargs=-Xmx4096m"
  # å›½å†…é•œåƒåŠ é€Ÿä¾èµ–ä¸‹è½½ï¼ˆå…³é”®ï¼è§£å†³è¶…æ—¶ï¼‰
  PIP_INDEX_URL: https://pypi.tuna.tsinghua.edu.cn/simple
  ANDROID_SDK_DOWNLOAD_SOURCE: https://mirrors.tuna.tsinghua.edu.cn/android-sdk/

jobs:
  build-android:
    runs-on: ubuntu-latest
    # å¢å¤§è™šæ‹Ÿæœºèµ„æºï¼ˆé¿å…å†…å­˜ä¸è¶³ï¼‰
    timeout-minutes: 60
    resources:
      cpu: 4
      memory: 8G

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”¥ ä¿®å¤1ï¼šæ¸…ç†ç³»ç»Ÿæ®‹ç•™ + æ‰©å®¹ç£ç›˜
      run: |
        # æ¸…ç†ç³»ç»Ÿåƒåœ¾ï¼ˆé‡Šæ”¾ç©ºé—´ï¼‰
        sudo apt-get clean
        sudo rm -rf /var/lib/apt/lists/*
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android/sdk/cmdline-tools/latest/bin/avdmanager
        # æ‰©å®¹ä¸´æ—¶ç›®å½•ï¼ˆé¿å…ç£ç›˜ä¸è¶³ï¼‰
        sudo fallocate -l 10G /swapfile
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile

    - name: Set up Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle  # ç¼“å­˜Gradleï¼ŒåŠ é€Ÿæ„å»º

    - name: Set up Python 3.9
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        cache: pip  # ç¼“å­˜pipä¾èµ–

    - name: ğŸ”¥ ä¿®å¤2ï¼šå®‰è£…å®Œæ•´ç³»ç»Ÿä¾èµ–ï¼ˆè¡¥å…¨ç¼ºå¤±é¡¹ï¼‰
      run: |
        sudo apt-get update -y
        sudo apt-get install -y --no-install-recommends \
            git zip unzip wget \
            python3-pip python3-setuptools python3-dev \
            autoconf automake libtool pkg-config \
            zlib1g-dev libncurses5-dev libncursesw5-dev \
            cmake libffi-dev libssl-dev libltdl-dev \
            openjdk-17-jdk-headless ant \
            libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev \
            libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev libsdl2-ttf-dev
        # å‡çº§pipåˆ°æœ€æ–°ç‰ˆ
        python -m pip install --upgrade pip setuptools wheel

    - name: ğŸ”¥ ä¿®å¤3ï¼šå®‰è£…Buildozer + å›ºå®šä¾èµ–ç‰ˆæœ¬ï¼ˆé¿å…å†²çªï¼‰
      run: |
        # å®‰è£…Buildozerï¼ˆæŒ‡å®šç¨³å®šç‰ˆæœ¬ï¼‰
        pip install buildozer==1.5.0
        # å®‰è£…Python-for-Androidï¼ˆæŒ‡å®šå…¼å®¹ç‰ˆæœ¬ï¼‰
        pip install python-for-android==2023.07.03
        # å®‰è£…é¡¹ç›®ä¾èµ–ï¼ˆåŒ¹é…buildozer.specï¼‰
        pip install cython==0.29.33 kivy==2.2.1 kivymd==1.2.0 pyjnius==1.4.0 requests==2.31.0

    - name: ğŸ”¥ ä¿®å¤4ï¼šå½»åº•æ¸…ç†æ‰€æœ‰ç¼“å­˜ï¼ˆæ ¸å¿ƒï¼ï¼‰
      run: |
        # æ¸…ç†Buildozeré¡¹ç›®ç¼“å­˜
        buildozer android clean || true
        # åˆ é™¤å…¨å±€ç¼“å­˜ï¼ˆå¼ºåˆ¶é‡æ–°ä¸‹è½½ä¾èµ–ï¼‰
        rm -rf ~/.buildozer/
        rm -rf ~/.cache/pip/
        rm -rf ~/.gradle/
        # åˆ é™¤æœ¬åœ°æ„å»ºäº§ç‰©
        rm -rf ./bin/ ./build/ ./.__main__.py

    - name: ğŸ”¥ ä¿®å¤5ï¼šé¢„ä¸‹è½½Gradleï¼ˆè§£å†³ä¸‹è½½è¶…æ—¶ï¼‰
      run: |
        # åˆ›å»ºGradleç¼“å­˜ç›®å½•
        mkdir -p ~/.buildozer/android/platform/buildozer-gradle/
        # é¢„ä¸‹è½½Gradle 7.2.0ï¼ˆå…¼å®¹ä½ çš„é…ç½®ï¼‰
        wget -q -O ~/.buildozer/android/platform/buildozer-gradle/gradle-7.2.0-all.zip \
            https://services.gradle.org/distributions/gradle-7.2.0-all.zip

    - name: Build APK with Buildozerï¼ˆå¸¦è¯¦ç»†æ—¥å¿—ï¼‰
      run: |
        export PATH="$HOME/.local/bin:$PATH"
        # ç¯å¢ƒæ£€æŸ¥ï¼ˆè¾“å‡ºå…³é”®ä¿¡æ¯ï¼‰
        echo "===== ç¯å¢ƒä¿¡æ¯ ====="
        java -version
        python --version
        buildozer --version
        df -h  # æ£€æŸ¥ç£ç›˜ç©ºé—´
        free -m # æ£€æŸ¥å†…å­˜
        
        # å…³é”®ï¼šå¼ºåˆ¶ä½¿ç”¨é¢„ä¸‹è½½çš„Gradle
        sed -i 's/android.gradle_download =.*/android.gradle_download = file:\/\/\/home\/runner\/.buildozer\/android\/platform\/buildozer-gradle\/gradle-7.2.0-all.zip/' buildozer.spec
        sed -i 's/android.gradle_plugin =.*/android.gradle_plugin = 7.2.0/' buildozer.spec
        sed -i 's/p4a.gradle_dependencies =.*/p4a.gradle_dependencies = gradle:7.2.0/' buildozer.spec
        
        # æ„å»ºAPKï¼ˆè¾“å‡ºæ‰€æœ‰æ—¥å¿—ï¼‰
        buildozer -v android debug 2>&1 | tee buildozer.log
        
        # æŸ¥æ‰¾APKå¹¶å¤åˆ¶åˆ°æ ¹ç›®å½•ï¼ˆå…¼å®¹æ‰€æœ‰è·¯å¾„ï¼‰
        echo "===== æŸ¥æ‰¾APKæ–‡ä»¶ ====="
        find /home/runner -name "*.apk" -type f | tee apk_list.txt
        if [ -s apk_list.txt ]; then
          cp $(cat apk_list.txt | head -n1) ./esp32app-debug.apk
          echo "===== ç”Ÿæˆçš„APKä¿¡æ¯ ====="
          ls -la ./esp32app-debug.apk
        else
          echo "âŒ æœªæ‰¾åˆ°APKæ–‡ä»¶"
          exit 1
        fi

    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: kivy-app-apk
        path: ./esp32app-debug.apk
        retention-days: 30

    - name: Upload debug logsï¼ˆåŒ…å«æ‰€æœ‰å…³é”®ä¿¡æ¯ï¼‰
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: full-build-logs
        path: |
          buildozer.log
          apk_list.txt
          buildozer.spec
        retention-days: 7
